# Backend Инфокиоска

## Основные используемые технологии:
* __python 3.8__
* __[Flask](https://flask.palletsprojects.com/en/2.3.x/)__
* __[Flask-SqlAlchemy](https://flask-sqlalchemy.palletsprojects.com/en/3.0.x/)__ - для связи с базой данных посредством ORM
* __[Marshmallow](https://marshmallow.readthedocs.io/en/stable/)__ - для сериализации данных
* __[Flask-migrate](https://flask-migrate.readthedocs.io/en/latest/)__ - для миграций БД

*Стоит почитать документацию используемых библиотек для понимания кода*

## Деплой

### 1. Клонируем этот репозиторий

`git clone https://github.com/coca-in-a-cola/rmr-infokiosk-api.git`

### 2. Переключаемся на python версии 3.8

Самый простой способ - установить [pyenv](https://github.com/pyenv/pyenv).

При наличии pyenv, Pipenv в свою очередь сам установит python нужной (3.8) версии

### 3. Настраиваем окружение
* Для запуска понадобится [pipenv](https://pipenv.pypa.io/en/latest/), его можно установить через pip:
    
    ```pip install pipenv```

* С помошью pipenv подтягиваются остальные пакеты:

    ```pipenv install```

* Теперь необходимо отредактировать настройки инфокиоска
    * `app_config.py` - опционально, там уже всё настроено
    * `app_secrets.py.example` (скопировать как `app_secrets.py`) - обязательно для работы системы.
    Из-за соображений безопасности `app_secrets.py` не передаётся в гите.

> **ВНИМАНИЕ! Все команды, использующие модули python приложения (например `flask db upgrade`) мы запускаем через виртуальное окружение - `pipenv run {команда}`**
### 4. Настройка БД
Для начала нам необходим файл `db/Main.db`. Мы можем взять готовый с рабочего инфокиоска, либо создать пустой файл.

#### 4.1 - Файл рабочего инфокиоска - Запускаем миграции

```pipenv run flask db upgrade```

За подробностями - в документацию [Flask-migrate](https://flask-migrate.readthedocs.io/en/latest/)

#### 4.2 - Новый файл (либо не получилось 4.1) - Форматируем БД.

* Создаём пустой файл в директории 

    ```mkdir db && touch db/Main.db```


* Запустим инфокиоск с форматированием таблиц
    
    ```pipenv run python app.py -c```

* Переходим на URL инфокиоска, чтобы применить форматирование (по умолчанию http://127.0.0.1:5000)

* Чтобы вести историю миграций, пропишите `flask db init` и `flask db migrate -m "Initial migration."`

* Обратим внимание - главная страница выдала 404 ошибку, потому что у нас не задано главное меню.

### 5. (Опционально) Деплой фронтенда

[**Ссылка на фронтенд инфокиоска**](https://github.com/coca-in-a-cola/new-infokiosk-frontend)

Собранный фронтенд уже доступен в репозитории в папке `spa`.
Если вам необходимо применить обновление фронтенда, соберите его с помошью `npm run build` в корне проекта с фронтендом, и откопируйте файлы из выходой директории (как правило `build` или `dist`) в папку `spa` данного проекта.

---
На этом деплой проекта в любое окружение - для билда или для разработки - можно считать завершённым.

## Агрументы запуска

Для просмотра всех аргументов, запустите

```pipenv run python app.py --help```

**В боевом режиме инфокиоск запускается командой**
    ```pipenv run python app.py -b -g```


## Администрирование

Контент загружается через REST API, для редактирования данных необходимо указывать авторизацию вида basic с логином/паролем admin_login и admin_password соответсвенно, указанными в конфиге.

*Ссылку на postman с примерами запросов здесь не могу выложить из-за соображений безопасности, ищите в тг-чате по хештегу #postman*
